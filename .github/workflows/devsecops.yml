name: DevSecOps Pipeline

on: [push, pull_request]

jobs:

  # =====================================================
  # 1. SAST (Snyk Code)
  # =====================================================
  sast:
    runs-on: ubuntu-latest
    outputs:
      sast_failed: ${{ steps.sast-scan.outputs.failed }}

    steps:
      - uses: actions/checkout@v4
      - uses: snyk/actions/setup@master

      - name: Run Snyk SAST
        id: sast-scan
        run: |
          # Run Snyk and capture non-zero exit into step output 'failed'
          snyk code test --severity-threshold=high --json > sast-report.json || echo "failed=true" >> $GITHUB_OUTPUT
          echo "report_path=sast-report.json" >> $GITHUB_OUTPUT
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Upload SAST Report
        uses: actions/upload-artifact@v4
        with:
          name: sast-report
          path: sast-report.json

  # =====================================================
  # 2. SCA (Snyk Open Source)
  # =====================================================
  sca:
    runs-on: ubuntu-latest
    needs: sast
    outputs:
      sca_failed: ${{ steps.sca-scan.outputs.failed }}

    steps:
      - uses: actions/checkout@v4
      - uses: snyk/actions/setup@master

      - name: Run Snyk SCA
        id: sca-scan
        run: |
          snyk test --all-projects --severity-threshold=high --json > sca-report.json || echo "failed=true" >> $GITHUB_OUTPUT
          echo "report_path=sca-report.json" >> $GITHUB_OUTPUT
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Upload SCA Report
        uses: actions/upload-artifact@v4
        with:
          name: sca-report
          path: sca-report.json

  # =====================================================
  # 3. IaC (Snyk IaC)
  # =====================================================
  iac:
    runs-on: ubuntu-latest
    needs: sca
    outputs:
      iac_failed: ${{ steps.iac-scan.outputs.failed }}

    steps:
      - uses: actions/checkout@v4
      - uses: snyk/actions/setup@master

      - name: Run Snyk IaC
        id: iac-scan
        run: |
          snyk iac test --severity-threshold=high --json > iac-report.json || echo "failed=true" >> $GITHUB_OUTPUT
          echo "report_path=iac-report.json" >> $GITHUB_OUTPUT
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Upload IaC Report
        uses: actions/upload-artifact@v4
        with:
          name: iac-report
          path: iac-report.json

  # =====================================================
  # 4. DAST (OWASP ZAP Baseline)
  # =====================================================
  dast:
    runs-on: ubuntu-latest
    needs: iac
    outputs:
      dast_failed: ${{ steps.zap-scan.outputs.failed }}

    steps:
      - uses: actions/checkout@v4

      - name: Build App Docker Image
        run: docker build -t myapp .

      - name: Run App Container
        run: |
          docker run -d -p 8080:8080 --name devsecapp myapp || true
          # wait for app to become available
          for i in {1..15}; do
            if curl -sSf http://localhost:8080 >/dev/null 2>&1; then
              break
            fi
            sleep 2
          done

      - name: Run ZAP Baseline Scan
        id: zap-scan
        uses: zaproxy/action-baseline@v0.9.0
        with:
          target: "http://localhost:8080"
          cmd_options: "-j"
        # If the action exits non-zero, capture into step output 'failed' so job still continues:
        continue-on-error: false

      # Mark failure for ZAP if the previous step produced a non-zero exit (we need to detect it).
      # The zap action writes zap_baseline.json on success; when it fails it may not. We will check exit code via a wrapper:
      - name: Normalize ZAP result to step output
        if: always()
        id: zap-scan-result
        run: |
          # If zap produced a baseline JSON, treat it as success; otherwise mark failed
          if [ -f zap_baseline.json ]; then
            # check if alerts exist: if file contains "alerts" and non-empty, we could parse; but the action already returned non-zero on alerts.
            echo "failed=false" >> $GITHUB_OUTPUT
            echo "report_path=zap_baseline.json" >> $GITHUB_OUTPUT
          else
            echo "failed=true" >> $GITHUB_OUTPUT
            echo "report_path=zap_baseline.json" >> $GITHUB_OUTPUT
          fi

      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: zap_baseline.json

      - name: Cleanup App Container
        if: always()
        run: |
          docker ps -a --filter "name=devsecapp" --format "{{.ID}}" | xargs -r docker rm -f

  # =====================================================
  # 5. SUMMARY: Fail overall workflow if ANY scan reported failure
  # =====================================================
  summary:
    runs-on: ubuntu-latest
    needs: [sast, sca, iac, dast]

    steps:
      - name: Show job outputs (debug)
        run: |
          echo "sast_failed: ${{ needs.sast.outputs.sast_failed }}"
          echo "sca_failed:  ${{ needs.sca.outputs.sca_failed }}"
          echo "iac_failed:  ${{ needs.iac.outputs.iac_failed }}"
          echo "dast_failed: ${{ needs.dast.outputs.dast_failed }}"

      - name: Fail if any scan failed
        run: |
          if [ "${{ needs.sast.outputs.sast_failed }}" = "true" ] || \
             [ "${{ needs.sca.outputs.sca_failed }}" = "true" ] || \
             [ "${{ needs.iac.outputs.iac_failed }}" = "true" ] || \
             [ "${{ needs.dast.outputs.dast_failed }}" = "true" ]; then
            echo "One or more scans detected HIGH/CRITICAL issues. Failing workflow."
            exit 1
          fi
          echo "All scans passed the configured severity threshold."
