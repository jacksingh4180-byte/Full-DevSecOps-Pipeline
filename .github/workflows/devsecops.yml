name: DevSecOps Pipeline

# ðŸ” REQUIRED PERMISSIONS (fixes â€œResource not accessible by integrationâ€)
permissions:
  contents: read
  security-events: write
  actions: read

on:
  push:
    branches: [ main ]
  pull_request:

jobs:

  # --------------------- SAST (Snyk Code) ---------------------
  sast:
    name: SAST - Snyk Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Snyk
        uses: snyk/actions/setup@master

      - name: SAST Scan
        continue-on-error: true
        run: snyk code test --sarif-file-output=snyk-code.sarif

      - name: Upload SAST SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: snyk-code.sarif


  # --------------------- SCA (Dependencies) ---------------------
  sca:
    name: SCA - Snyk Open Source
    runs-on: ubuntu-latest
    needs: sast

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Snyk
        uses: snyk/actions/setup@master

      - name: SCA Scan
        continue-on-error: true
        run: snyk test --sarif-file-output=snyk-sca.sarif

      - name: Upload SCA SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: snyk-sca.sarif


  # --------------------- IaC Scan ---------------------
  iac:
    name: IaC - Snyk
    runs-on: ubuntu-latest
    needs: sca

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Snyk
        uses: snyk/actions/setup@master

      - name: IaC Scan
        continue-on-error: true
        run: snyk iac test --sarif-file-output=snyk-iac.sarif

      - name: Upload IaC SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: snyk-iac.sarif


  # --------------------- DAST (OWASP ZAP Baseline) ---------------------
  dast:
    name: DAST - OWASP ZAP Baseline
    runs-on: ubuntu-latest
    needs: iac

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run ZAP Baseline Scan
        continue-on-error: true
        run: |
          docker run --user root -v $(pwd):/zap/wrk/:rw \
            -t owasp/zap2docker-stable zap-baseline.py \
            -t http://localhost:3000 \
            -x zap-report.xml \
            -J zap-report.json \
            -w zap-report.html

      - name: Convert ZAP XML -> SARIF
        continue-on-error: true
        run: |
          pip install sarif-tools
          sarif-tools convert zap-report.xml zap.sarif

      - name: Upload DAST SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: zap.sarif


  # --------------------- FINAL SUMMARY ---------------------
  summary:
    name: DevSecOps Summary
    runs-on: ubuntu-latest
    needs: [sast, sca, iac, dast]

    steps:
      - name: Print Summary
        run: |
          echo "âœ… DevSecOps Pipeline Completed"
          echo "SAST, SCA, IaC and DAST executed successfully."
          echo "Check security tab for full SARIF report uploads."
