name: DevSecOps Pipeline

on: [push, pull_request]

jobs:

  # =====================================================
  # 1. SAST (Snyk Code)
  # =====================================================
  sast:
    runs-on: ubuntu-latest
    outputs:
      failed: ${{ steps.sast-scan.outputs.failed }}

    steps:
      - uses: actions/checkout@v4
      - uses: snyk/actions/setup@master

      - name: Run Snyk SAST
        id: sast-scan
        run: |
          snyk code test --severity-threshold=high --json > sast-report.json || echo "failed=true" >> $GITHUB_OUTPUT
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Upload SAST Report
        uses: actions/upload-artifact@v4
        with:
          name: sast-report
          path: sast-report.json

      - name: Fail SAST Job
        if: steps.sast-scan.outputs.failed == 'true'
        run: exit 1


  # =====================================================
  # 2. SCA (Snyk Open Source)
  # =====================================================
  sca:
    runs-on: ubuntu-latest
    needs: sast
    continue-on-error: true
    outputs:
      failed: ${{ steps.sca-scan.outputs.failed }}

    steps:
      - uses: actions/checkout@v4
      - uses: snyk/actions/setup@master

      - name: Run Snyk SCA
        id: sca-scan
        run: |
          snyk test --all-projects --severity-threshold=high --json > sca-report.json || echo "failed=true" >> $GITHUB_OUTPUT
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Upload SCA Report
        uses: actions/upload-artifact@v4
        with:
          name: sca-report
          path: sca-report.json

      - name: Fail SCA Job
        if: steps.sca-scan.outputs.failed == 'true'
        run: exit 1



  # =====================================================
  # 3. IaC (Snyk IaC)
  # =====================================================
  iac:
    runs-on: ubuntu-latest
    needs: sca
    continue-on-error: true
    outputs:
      failed: ${{ steps.iac-scan.outputs.failed }}

    steps:
      - uses: actions/checkout@v4
      - uses: snyk/actions/setup@master

      - name: Run Snyk IaC
        id: iac-scan
        run: |
          snyk iac test --severity-threshold=high --json > iac-report.json || echo "failed=true" >> $GITHUB_OUTPUT
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Upload IaC Report
        uses: actions/upload-artifact@v4
        with:
          name: iac-report
          path: iac-report.json

      - name: Fail IaC Job
        if: steps.iac-scan.outputs.failed == 'true'
        run: exit 1



  # =====================================================
  # 4. DAST (OWASP ZAP Baseline)
  # =====================================================
  dast:
    runs-on: ubuntu-latest
    needs: iac
    continue-on-error: true
    outputs:
      failed: ${{ steps.dast-check.outputs.failed }}

    steps:
      - uses: actions/checkout@v4

      - name: Build App Docker Image
        run: docker build -t myapp .

      - name: Run App Container
        run: |
          docker run -d -p 8080:8080 --name devsecapp myapp
          sleep 15

      - name: Run ZAP Baseline Scan
        id: zap-scan
        uses: zaproxy/action-baseline@v0.9.0
        with:
          target: "http://localhost:8080"
          cmd_options: "-j"

      - name: Mark DAST Failed
        id: dast-check
        if: failure()
        run: echo "failed=true" >> $GITHUB_OUTPUT

      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: zap_baseline.json

      - name: Fail DAST Job
        if: steps.dast-check.outputs.failed == 'true'
        run: exit 1



  # =====================================================
  # 5. FINAL SUMMARY â†’ FAIL OVERALL WORKFLOW
  # =====================================================
  summary:
    runs-on: ubuntu-latest
    needs: [sast, sca, iac, dast]

    steps:
      - name: Fail if SAST Failed
        if: ${{ needs.sast.outputs.failed == 'true' }}
        run: exit 1

      - name: Fail if SCA Failed
        if: ${{ needs.sca.outputs.failed == 'true' }}
        run: exit 1

      - name: Fail if IaC Failed
        if: ${{ needs.iac.outputs.failed == 'true' }}
        run: exit 1

      - name: Fail if DAST Failed
        if: ${{ needs.dast.outputs.failed == 'true' }}
        run: exit 1

      - name: Pipeline Passed
        run: echo "All DevSecOps scans passed successfully!"
